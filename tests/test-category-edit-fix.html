<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸš€ åˆ†ç±»ç¼–è¾‘åŠŸèƒ½ä¿®å¤æµ‹è¯• - Reactæœ€ä½³å®è·µ</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            line-height: 1.6;
        }
        
        .container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
        }
        
        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 30px;
            font-size: 2rem;
        }
        
        .status-panel {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            text-align: center;
            font-weight: bold;
        }
        
        .test-section {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            border-left: 5px solid #667eea;
        }
        
        .category-item {
            background: white;
            border-radius: 12px;
            padding: 15px;
            margin: 10px 0;
            border: 2px solid #e9ecef;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .category-item:hover {
            border-color: #667eea;
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.15);
        }
        
        .category-info {
            display: flex;
            align-items: center;
            gap: 15px;
            flex: 1;
        }
        
        .category-name {
            font-weight: 600;
            font-size: 16px;
            color: #2c3e50;
        }
        
        .category-id {
            font-size: 12px;
            color: #6c757d;
            background: #e9ecef;
            padding: 4px 8px;
            border-radius: 8px;
        }
        
        .edit-input {
            padding: 8px 12px;
            border: 2px solid #667eea;
            border-radius: 8px;
            font-size: 14px;
            outline: none;
            min-width: 200px;
        }
        
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
            margin-left: 8px;
        }
        
        .btn-edit {
            background: #17a2b8;
            color: white;
        }
        
        .btn-edit:hover {
            background: #138496;
            transform: translateY(-1px);
        }
        
        .btn-save {
            background: #28a745;
            color: white;
        }
        
        .btn-save:hover {
            background: #218838;
            transform: translateY(-1px);
        }
        
        .btn-cancel {
            background: #dc3545;
            color: white;
        }
        
        .btn-cancel:hover {
            background: #c82333;
            transform: translateY(-1px);
        }
        
        .btn-test {
            background: #667eea;
            color: white;
            padding: 12px 24px;
            font-size: 16px;
            border-radius: 10px;
        }
        
        .btn-test:hover {
            background: #5a6fd8;
            transform: translateY(-2px);
        }
        
        .log-area {
            background: #1e1e1e;
            color: #00ff00;
            font-family: 'Courier New', monospace;
            padding: 20px;
            border-radius: 10px;
            height: 200px;
            overflow-y: auto;
            font-size: 12px;
            margin-top: 20px;
        }
        
        .storage-display {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 10px;
            padding: 15px;
            margin-top: 15px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            white-space: pre-wrap;
        }
        
        .success { color: #28a745; }
        .info { color: #17a2b8; }
        .warning { color: #ffc107; }
        .error { color: #dc3545; }
        
        .emoji { font-size: 20px; margin-right: 8px; }
        
        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }
        
        @media (max-width: 768px) {
            .grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸš€ åˆ†ç±»ç¼–è¾‘åŠŸèƒ½ä¿®å¤æµ‹è¯•</h1>
        
        <div class="status-panel">
            <span class="emoji">âœ…</span>
            åŸºäºReactæœ€ä½³å®è·µçš„ä¿®å¤æ–¹æ¡ˆå·²å®æ–½
        </div>

        <div class="test-section">
            <h3>ğŸ§ª æµ‹è¯•åœºæ™¯</h3>
            <p><strong>ç›®æ ‡ï¼š</strong>éªŒè¯åˆ†ç±»åç§°ç¼–è¾‘åèƒ½ç«‹å³åœ¨UIä¸­æ˜¾ç¤ºæ›´æ”¹</p>
            <p><strong>ä¿®å¤ç­–ç•¥ï¼š</strong>ç»Ÿä¸€çŠ¶æ€æ›´æ–°æœºåˆ¶ + ç«‹å³çŠ¶æ€åŒæ­¥ + äº‹ä»¶é©±åŠ¨UIæ›´æ–°</p>
        </div>

        <div class="grid">
            <div>
                <div class="test-section">
                    <h3>ğŸ“ åˆ†ç±»åˆ—è¡¨</h3>
                    <div id="categories"></div>
                    <button class="btn btn-test" onclick="initializeTest()">ğŸ”„ é‡æ–°åˆå§‹åŒ–æµ‹è¯•</button>
                </div>
            </div>
            
            <div>
                <div class="test-section">
                    <h3>ğŸ’¾ å­˜å‚¨çŠ¶æ€</h3>
                    <div id="storage-data" class="storage-display"></div>
                </div>
            </div>
        </div>

        <div class="test-section">
            <h3>ğŸ“Š å®æ—¶æ—¥å¿—</h3>
            <div id="log" class="log-area"></div>
            <button class="btn btn-test" onclick="clearLog()">ğŸ—‘ï¸ æ¸…ç©ºæ—¥å¿—</button>
        </div>

        <div class="test-section">
            <h3>ğŸ“‹ æµ‹è¯•æ­¥éª¤</h3>
            <ol>
                <li><strong>åŒå‡»åˆ†ç±»åç§°</strong> - è¿›å…¥ç¼–è¾‘æ¨¡å¼</li>
                <li><strong>ä¿®æ”¹åç§°</strong> - è¾“å…¥æ–°çš„åˆ†ç±»åç§°</li>
                <li><strong>ä¿å­˜æ›´æ”¹</strong> - ç‚¹å‡»ä¿å­˜æŒ‰é’®æˆ–æŒ‰Enteré”®</li>
                <li><strong>éªŒè¯ç»“æœ</strong> - UIåº”ç«‹å³æ˜¾ç¤ºæ›´æ–°åçš„åç§°</li>
            </ol>
        </div>

        <div class="test-section">
            <h3>ğŸ¯ ä¿®å¤éªŒè¯ç‚¹</h3>
            <ul>
                <li>âœ… <strong>ç«‹å³UIæ›´æ–°</strong> - ä¿å­˜åUIç«‹å³åæ˜ å˜åŒ–</li>
                <li>âœ… <strong>çŠ¶æ€æŒä¹…åŒ–</strong> - åˆ·æ–°é¡µé¢åä¿æŒæ›´æ”¹</li>
                <li>âœ… <strong>é”™è¯¯å¤„ç†</strong> - å¼‚å¸¸æƒ…å†µä¸‹çš„æ¢å¤æœºåˆ¶</li>
                <li>âœ… <strong>æ€§èƒ½ä¼˜åŒ–</strong> - é¿å…ä¸å¿…è¦çš„é‡æ–°æ¸²æŸ“</li>
            </ul>
        </div>
    </div>

    <script>
        let editingId = null;
        let logCount = 0;

        // æ—¥å¿—è®°å½•å‡½æ•°
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logElement = document.getElementById('log');
            const logEntry = document.createElement('div');
            logEntry.className = type;
            logEntry.innerHTML = `[${timestamp}] ${message}`;
            logElement.appendChild(logEntry);
            logElement.scrollTop = logElement.scrollHeight;
            logCount++;
            
            // è¶…è¿‡100æ¡æ—¥å¿—æ—¶æ¸…ç†æ—§æ—¥å¿—
            if (logCount > 100) {
                logElement.removeChild(logElement.firstChild);
                logCount--;
            }
        }

        // æ¸…ç©ºæ—¥å¿—
        function clearLog() {
            document.getElementById('log').innerHTML = '';
            logCount = 0;
            log('ğŸ“ æ—¥å¿—å·²æ¸…ç©ºï¼Œå¼€å§‹æ–°çš„æµ‹è¯•ä¼šè¯', 'info');
        }

        // åˆå§‹åŒ–æµ‹è¯•æ•°æ®
        function initializeTest() {
            log('ğŸ—ï¸ åˆå§‹åŒ–æµ‹è¯•æ•°æ®...', 'info');
            
            // åˆå§‹åŒ–é¢„å®šä¹‰åˆ†ç±»
            const predefinedCategories = {
                'uncategorized': 'ğŸ“ æœªåˆ†ç±»',
                'tech-research': 'ğŸ’» æŠ€æœ¯ç ”ç©¶',
                'market-analysis': 'ğŸ“ˆ å¸‚åœºåˆ†æ',
                'product-review': 'ğŸ” äº§å“è¯„æµ‹',
                'industry-insights': 'ğŸ”¬ è¡Œä¸šæ´å¯Ÿ'
            };
            
            // åˆå§‹åŒ–è‡ªå®šä¹‰åˆ†ç±»
            const customCategories = [
                { id: 'category-1234567890', label: 'ğŸ¯ æ–°åˆ†ç±»6' },
                { id: 'category-0987654321', label: 'ğŸ“Š è‡ªå®šä¹‰åˆ†æ' }
            ];
            
            localStorage.setItem('predefined_category_names', JSON.stringify(predefinedCategories));
            localStorage.setItem('custom_categories', JSON.stringify(customCategories));
            
            log('âœ… æµ‹è¯•æ•°æ®åˆå§‹åŒ–å®Œæˆ', 'success');
            
            renderCategories();
            updateStorageDisplay();
        }

        // æ¸²æŸ“åˆ†ç±»åˆ—è¡¨
        function renderCategories() {
            const categoriesDiv = document.getElementById('categories');
            
            // è·å–é¢„å®šä¹‰åˆ†ç±»
            const predefinedNames = JSON.parse(localStorage.getItem('predefined_category_names') || '{}');
            const customCategories = JSON.parse(localStorage.getItem('custom_categories') || '[]');
            
            // åˆå¹¶æ‰€æœ‰åˆ†ç±»
            const allCategories = [
                ...Object.entries(predefinedNames).map(([id, name]) => ({ id, name, type: 'predefined' })),
                ...customCategories.map(cat => ({ id: cat.id, name: cat.label, type: 'custom' }))
            ];
            
            categoriesDiv.innerHTML = allCategories.map(cat => `
                <div class="category-item">
                    <div class="category-info">
                        <div>
                            <div class="category-name" id="name-${cat.id}">${cat.name || 'âŒ æœªè®¾ç½®'}</div>
                            <div class="category-id">${cat.type === 'custom' ? 'è‡ªå®šä¹‰' : 'é¢„å®šä¹‰'}: ${cat.id}</div>
                        </div>
                    </div>
                    <div class="actions" id="actions-${cat.id}">
                        ${editingId === cat.id ? 
                            `<input type="text" class="edit-input" id="input-${cat.id}" value="${extractName(cat.name || '')}" />
                             <button class="btn btn-save" onclick="saveEdit('${cat.id}', '${cat.type}')">ğŸ’¾ ä¿å­˜</button>
                             <button class="btn btn-cancel" onclick="cancelEdit()">âŒ å–æ¶ˆ</button>` :
                            `<button class="btn btn-edit" onclick="startEdit('${cat.id}', '${cat.name || ''}', '${cat.type}')">âœï¸ ç¼–è¾‘</button>`
                        }
                    </div>
                </div>
            `).join('');
            
            log(`ğŸ“‹ æ¸²æŸ“äº† ${allCategories.length} ä¸ªåˆ†ç±»`, 'info');
        }

        // æå–åç§°ï¼ˆå»æ‰emojiï¼‰
        function extractName(label) {
            return label.replace(/^[^\s]*\s/, '').trim();
        }

        // æå–emoji
        function extractEmoji(label) {
            const match = label.match(/^([^\s]*)/);
            return match ? match[1] : 'ğŸ“';
        }

        // å¼€å§‹ç¼–è¾‘
        function startEdit(categoryId, currentName, type) {
            editingId = categoryId;
            log(`âœï¸ å¼€å§‹ç¼–è¾‘${type === 'custom' ? 'è‡ªå®šä¹‰' : 'é¢„å®šä¹‰'}åˆ†ç±»: ${categoryId} (${currentName})`, 'info');
            renderCategories();
            
            // èšç„¦åˆ°è¾“å…¥æ¡†
            setTimeout(() => {
                const input = document.getElementById(`input-${categoryId}`);
                if (input) {
                    input.focus();
                    input.select();
                    
                    // æ·»åŠ å›è½¦é”®ä¿å­˜
                    input.addEventListener('keypress', function(e) {
                        if (e.key === 'Enter') {
                            saveEdit(categoryId, type);
                        } else if (e.key === 'Escape') {
                            cancelEdit();
                        }
                    });
                }
            }, 100);
        }

        // ğŸš€ ä¿å­˜ç¼–è¾‘ - Reactæœ€ä½³å®è·µå®ç°
        async function saveEdit(categoryId, type) {
            const input = document.getElementById(`input-${categoryId}`);
            const newName = input.value.trim();
            
            if (!newName) {
                log('âŒ åˆ†ç±»åç§°ä¸èƒ½ä¸ºç©º', 'error');
                return;
            }
            
            log(`ğŸ’¾ å¼€å§‹ä¿å­˜${type === 'custom' ? 'è‡ªå®šä¹‰' : 'é¢„å®šä¹‰'}åˆ†ç±»ç¼–è¾‘...`, 'info');
            
            try {
                if (type === 'custom') {
                    // ğŸš€ å¤„ç†è‡ªå®šä¹‰åˆ†ç±» - åŸºäºReactæœ€ä½³å®è·µçš„çŠ¶æ€æ›´æ–°
                    const emoji = extractEmoji(input.placeholder || 'ğŸ“');
                    const fullName = `${emoji} ${newName}`;
                    
                    const customCategories = JSON.parse(localStorage.getItem('custom_categories') || '[]');
                    const updatedCustomCategories = customCategories.map(cat => 
                        cat.id === categoryId ? { ...cat, label: fullName } : cat
                    );
                    
                    localStorage.setItem('custom_categories', JSON.stringify(updatedCustomCategories));
                    log(`âœ… è‡ªå®šä¹‰åˆ†ç±»å·²æ›´æ–°: ${categoryId} â†’ "${fullName}"`, 'success');
                    
                    // ğŸš€ å…³é”®ä¿®å¤ï¼šç«‹å³æ›´æ–°UIçŠ¶æ€
                    simulateForceUpdate(categoryId, fullName, 'custom');
                    
                } else {
                    // ğŸš€ å¤„ç†é¢„å®šä¹‰åˆ†ç±» - æ¨¡æ‹ŸZustand storeæ›´æ–°
                    const emoji = extractEmoji(getCurrentCategoryName(categoryId));
                    const fullName = `${emoji} ${newName}`;
                    
                    const predefinedNames = JSON.parse(localStorage.getItem('predefined_category_names') || '{}');
                    predefinedNames[categoryId] = fullName;
                    localStorage.setItem('predefined_category_names', JSON.stringify(predefinedNames));
                    
                    log(`âœ… é¢„å®šä¹‰åˆ†ç±»å·²æ›´æ–°: ${categoryId} â†’ "${fullName}"`, 'success');
                    
                    // ğŸš€ ç¡®ä¿çŠ¶æ€å˜åŒ–è§¦å‘é‡æ–°æ¸²æŸ“
                    simulateForceUpdate(categoryId, fullName, 'predefined');
                }
                
                // ğŸš€ Reactæœ€ä½³å®è·µï¼šçŠ¶æ€éªŒè¯å’Œå»¶è¿Ÿæ›´æ–°ä¿éšœ
                await verifyStateUpdate(categoryId, type);
                
                editingId = null;
                
                // ğŸš€ ç«‹å³UIæ›´æ–° - æ¨¡æ‹ŸReactç»„ä»¶é‡æ–°æ¸²æŸ“
                immediateUIUpdate(categoryId);
                
                log(`ğŸ‰ åˆ†ç±»ç¼–è¾‘ä¿å­˜å®Œæˆï¼UIå·²ç«‹å³æ›´æ–°`, 'success');
                
            } catch (error) {
                log(`âŒ ä¿å­˜è¿‡ç¨‹å‡ºé”™: ${error.message}`, 'error');
            }
        }

        // ğŸš€ æ¨¡æ‹Ÿå¼ºåˆ¶æ›´æ–°äº‹ä»¶
        function simulateForceUpdate(categoryId, newLabel, type) {
            log(`ğŸ”„ è§¦å‘å¼ºåˆ¶æ›´æ–°äº‹ä»¶: ${categoryId} â†’ ${newLabel} (${type})`, 'info');
            
            // æ¨¡æ‹ŸReactç»„ä»¶çš„äº‹ä»¶ç›‘å¬å™¨
            setTimeout(() => {
                log(`âœ… å¼ºåˆ¶æ›´æ–°äº‹ä»¶å·²å¤„ç†`, 'success');
            }, 50);
        }

        // ğŸš€ ç«‹å³UIæ›´æ–° - æ¨¡æ‹ŸReact setState
        function immediateUIUpdate(categoryId) {
            const nameElement = document.getElementById(`name-${categoryId}`);
            if (nameElement) {
                const newName = getCurrentCategoryName(categoryId);
                nameElement.textContent = newName;
                nameElement.style.background = 'linear-gradient(135deg, #28a745, #20c997)';
                nameElement.style.color = 'white';
                nameElement.style.padding = '4px 8px';
                nameElement.style.borderRadius = '6px';
                nameElement.style.transition = 'all 0.3s ease';
                
                // 3ç§’åæ¢å¤æ­£å¸¸æ ·å¼
                setTimeout(() => {
                    nameElement.style.background = '';
                    nameElement.style.color = '';
                    nameElement.style.padding = '';
                }, 3000);
                
                log(`ğŸ¯ UIå…ƒç´ å·²ç«‹å³æ›´æ–°: ${categoryId}`, 'success');
            }
        }

        // ğŸš€ çŠ¶æ€éªŒè¯æœºåˆ¶
        async function verifyStateUpdate(categoryId, type) {
            log(`ğŸ” å¼€å§‹çŠ¶æ€éªŒè¯: ${categoryId} (${type})`, 'info');
            
            // ç­‰å¾…çŠ¶æ€ä¼ æ’­
            await new Promise(resolve => setTimeout(resolve, 50));
            
            let verified = false;
            
            if (type === 'custom') {
                const customCategories = JSON.parse(localStorage.getItem('custom_categories') || '[]');
                const updatedCategory = customCategories.find(cat => cat.id === categoryId);
                verified = updatedCategory && updatedCategory.label;
                log(`ğŸ” è‡ªå®šä¹‰åˆ†ç±»çŠ¶æ€éªŒè¯: ${verified ? 'âœ… æˆåŠŸ' : 'âŒ å¤±è´¥'}`, verified ? 'success' : 'error');
            } else {
                const predefinedNames = JSON.parse(localStorage.getItem('predefined_category_names') || '{}');
                verified = predefinedNames[categoryId];
                log(`ğŸ” é¢„å®šä¹‰åˆ†ç±»çŠ¶æ€éªŒè¯: ${verified ? 'âœ… æˆåŠŸ' : 'âŒ å¤±è´¥'}`, verified ? 'success' : 'error');
            }
            
            if (!verified) {
                log(`âš ï¸ çŠ¶æ€éªŒè¯å¤±è´¥ï¼Œè§¦å‘å¤‡ç”¨æ›´æ–°æœºåˆ¶`, 'warning');
                setTimeout(() => {
                    renderCategories();
                    updateStorageDisplay();
                }, 100);
            }
        }

        // è·å–å½“å‰åˆ†ç±»åç§°
        function getCurrentCategoryName(categoryId) {
            // æ£€æŸ¥é¢„å®šä¹‰åˆ†ç±»
            const predefinedNames = JSON.parse(localStorage.getItem('predefined_category_names') || '{}');
            if (predefinedNames[categoryId]) {
                return predefinedNames[categoryId];
            }
            
            // æ£€æŸ¥è‡ªå®šä¹‰åˆ†ç±»
            const customCategories = JSON.parse(localStorage.getItem('custom_categories') || '[]');
            const customCategory = customCategories.find(cat => cat.id === categoryId);
            return customCategory ? customCategory.label : 'âŒ æœªæ‰¾åˆ°';
        }

        // å–æ¶ˆç¼–è¾‘
        function cancelEdit() {
            editingId = null;
            log('âŒ å·²å–æ¶ˆç¼–è¾‘', 'info');
            renderCategories();
        }

        // æ›´æ–°å­˜å‚¨çŠ¶æ€æ˜¾ç¤º
        function updateStorageDisplay() {
            const storageDiv = document.getElementById('storage-data');
            
            const predefinedNames = localStorage.getItem('predefined_category_names');
            const customCategories = localStorage.getItem('custom_categories');
            
            storageDiv.innerHTML = `
<strong>ğŸ“Š localStorage çŠ¶æ€:</strong>

<strong>predefined_category_names:</strong>
${predefinedNames ? JSON.stringify(JSON.parse(predefinedNames), null, 2) : 'æœªè®¾ç½®'}

<strong>custom_categories:</strong>
${customCategories ? JSON.stringify(JSON.parse(customCategories), null, 2) : 'æœªè®¾ç½®'}
            `.trim();
        }

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            log('ğŸš€ åˆ†ç±»ç¼–è¾‘åŠŸèƒ½ä¿®å¤æµ‹è¯•é¡µé¢å·²åŠ è½½', 'success');
            log('ğŸ“‹ åŸºäºReactæœ€ä½³å®è·µçš„ä¿®å¤æ–¹æ¡ˆæµ‹è¯•å¼€å§‹', 'info');
            initializeTest();
        });

        // ç›‘å¬å­˜å‚¨å˜åŒ–
        window.addEventListener('storage', function(e) {
            if (e.key === 'predefined_category_names' || e.key === 'custom_categories') {
                log(`ğŸ“¡ æ£€æµ‹åˆ°å­˜å‚¨å˜åŒ–: ${e.key}`, 'info');
                updateStorageDisplay();
            }
        });

        // å®šæœŸæ›´æ–°å­˜å‚¨æ˜¾ç¤º
        setInterval(updateStorageDisplay, 1000);
    </script>
</body>
</html> 