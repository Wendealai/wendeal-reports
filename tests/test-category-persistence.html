<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åˆ†ç±»åç§°æŒä¹…åŒ–æµ‹è¯•</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 40px auto;
            padding: 20px;
            background-color: #f8fafc;
        }
        .container {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }
        h1 {
            color: #1e293b;
            text-align: center;
            margin-bottom: 30px;
        }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            background: #f8fafc;
        }
        .test-section h3 {
            color: #3b82f6;
            margin-top: 0;
        }
        .category-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px;
            margin: 8px 0;
            background: white;
            border-radius: 6px;
            border: 1px solid #d1d5db;
        }
        .category-name {
            font-weight: 500;
        }
        .edit-input {
            padding: 6px 10px;
            border: 1px solid #3b82f6;
            border-radius: 4px;
            outline: none;
        }
        .btn {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            margin: 0 2px;
        }
        .btn-edit { background: #3b82f6; color: white; }
        .btn-save { background: #10b981; color: white; }
        .btn-cancel { background: #ef4444; color: white; }
        .btn-test { background: #8b5cf6; color: white; padding: 10px 20px; }
        .status {
            padding: 10px;
            border-radius: 6px;
            margin: 10px 0;
            font-weight: 500;
        }
        .status.success { background: #dcfce7; color: #166534; border: 1px solid #bbf7d0; }
        .status.error { background: #fef2f2; color: #dc2626; border: 1px solid #fecaca; }
        .status.info { background: #dbeafe; color: #1d4ed8; border: 1px solid #bfdbfe; }
        .data-display {
            background: #1e293b;
            color: #e2e8f0;
            padding: 15px;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”§ åˆ†ç±»åç§°æŒä¹…åŒ–æµ‹è¯•</h1>
        
        <div class="test-section">
            <h3>ğŸ“‹ å½“å‰åˆ†ç±»åˆ—è¡¨</h3>
            <div id="category-list"></div>
            <button class="btn btn-test" onclick="refreshCategories()">ğŸ”„ åˆ·æ–°åˆ†ç±»åˆ—è¡¨</button>
        </div>

        <div class="test-section">
            <h3>ğŸ’¾ æ•°æ®å­˜å‚¨çŠ¶æ€</h3>
            <h4>LocalStorage æ•°æ®ï¼š</h4>
            <div id="localStorage-data" class="data-display"></div>
            <h4>æ•°æ®åº“çŠ¶æ€ï¼š</h4>
            <div id="database-data" class="data-display"></div>
            <button class="btn btn-test" onclick="checkPersistence()">ğŸ” æ£€æŸ¥æŒä¹…åŒ–çŠ¶æ€</button>
        </div>

        <div class="test-section">
            <h3>ğŸ§ª æµ‹è¯•æ­¥éª¤</h3>
            <ol>
                <li>ä¿®æ”¹ä»»æ„åˆ†ç±»åç§°å¹¶ä¿å­˜</li>
                <li>æ£€æŸ¥localStorageå’Œæ•°æ®åº“æ˜¯å¦åŒæ­¥æ›´æ–°</li>
                <li>åˆ·æ–°é¡µé¢æµ‹è¯•æŒä¹…åŒ–æ•ˆæœ</li>
                <li>éªŒè¯ä¿®æ”¹æ˜¯å¦åœ¨åˆ·æ–°åä¾ç„¶ç”Ÿæ•ˆ</li>
            </ol>
            <button class="btn btn-test" onclick="runAutoTest()">ğŸ¤– è¿è¡Œè‡ªåŠ¨æµ‹è¯•</button>
            <button class="btn btn-test" onclick="testRefresh()">ğŸ”„ æµ‹è¯•é¡µé¢åˆ·æ–°</button>
        </div>

        <div class="test-section">
            <h3>ğŸ“Š æµ‹è¯•æ—¥å¿—</h3>
            <div id="test-log" class="data-display" style="height: 200px; overflow-y: auto;"></div>
            <button class="btn btn-test" onclick="clearLog()">ğŸ—‘ï¸ æ¸…ç©ºæ—¥å¿—</button>
        </div>
    </div>

    <script>
        let categories = {};
        let editingId = null;

        // æ—¥å¿—å‡½æ•°
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logDiv = document.getElementById('test-log');
            const colorMap = {
                info: '#3b82f6',
                success: '#10b981', 
                error: '#ef4444',
                warning: '#f59e0b'
            };
            logDiv.innerHTML += `<span style="color: ${colorMap[type] || '#6b7280'}">[${timestamp}] ${message}</span>\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        // åˆå§‹åŒ–åˆ†ç±»æ•°æ®
        function initializeCategories() {
            const existing = localStorage.getItem('predefined_category_names');
            if (!existing || existing === '{}') {
                log('ğŸ—ï¸ é¦–æ¬¡è®¿é—®ï¼Œåˆå§‹åŒ–åˆ†ç±»åç§°...', 'info');
                const initialCategories = {
                    'uncategorized': 'ğŸ“ æœªåˆ†ç±»',
                    'tech-research': 'ğŸ’» æŠ€æœ¯ç ”ç©¶',
                    'market-analysis': 'ğŸ“ˆ å¸‚åœºåˆ†æ',
                    'product-review': 'ğŸ” äº§å“è¯„æµ‹',
                    'industry-insights': 'ğŸ”¬ è¡Œä¸šæ´å¯Ÿ'
                };
                localStorage.setItem('predefined_category_names', JSON.stringify(initialCategories));
                categories = initialCategories;
                log('âœ… åˆ†ç±»åç§°åˆå§‹åŒ–å®Œæˆ', 'success');
            } else {
                categories = JSON.parse(existing);
                log('ğŸ“Š è¯»å–ç°æœ‰åˆ†ç±»åç§°å®Œæˆ', 'info');
            }
        }

        // æ¸²æŸ“åˆ†ç±»åˆ—è¡¨
        function renderCategories() {
            const listDiv = document.getElementById('category-list');
            listDiv.innerHTML = '';

            Object.entries(categories).forEach(([id, name]) => {
                const div = document.createElement('div');
                div.className = 'category-item';
                
                if (editingId === id) {
                    // ç¼–è¾‘æ¨¡å¼
                    div.innerHTML = `
                        <input type="text" class="edit-input" id="edit-${id}" value="${name.replace(/^[^\\s]*\\s/, '').trim()}" />
                        <div>
                            <button class="btn btn-save" onclick="saveEdit('${id}')">ğŸ’¾ ä¿å­˜</button>
                            <button class="btn btn-cancel" onclick="cancelEdit()">âŒ å–æ¶ˆ</button>
                        </div>
                    `;
                    setTimeout(() => {
                        const input = document.getElementById(`edit-${id}`);
                        if (input) {
                            input.focus();
                            input.select();
                        }
                    }, 100);
                } else {
                    // æ™®é€šæ¨¡å¼
                    div.innerHTML = `
                        <span class="category-name">${name}</span>
                        <button class="btn btn-edit" onclick="startEdit('${id}', '${name}')">âœï¸ ç¼–è¾‘</button>
                    `;
                }
                
                listDiv.appendChild(div);
            });
        }

        // å¼€å§‹ç¼–è¾‘
        function startEdit(id, name) {
            editingId = id;
            log(`âœï¸ å¼€å§‹ç¼–è¾‘åˆ†ç±»: ${id}`, 'info');
            renderCategories();
        }

        // ä¿å­˜ç¼–è¾‘
        async function saveEdit(id) {
            const input = document.getElementById(`edit-${id}`);
            const newName = input.value.trim();
            
            if (!newName) {
                showStatus('âŒ åˆ†ç±»åç§°ä¸èƒ½ä¸ºç©º', 'error');
                return;
            }

            const emoji = categories[id].split(' ')[0];
            const fullName = `${emoji} ${newName}`;
            
            log(`ğŸ’¾ ä¿å­˜åˆ†ç±»ç¼–è¾‘: ${id} â†’ "${fullName}"`, 'info');

            try {
                // æ›´æ–°localStorage
                categories[id] = fullName;
                localStorage.setItem('predefined_category_names', JSON.stringify(categories));
                log(`âœ… localStorageå·²æ›´æ–°`, 'success');

                // åŒæ­¥åˆ°æ•°æ®åº“
                const response = await fetch('/api/categories/predefined', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        categoryId: id,
                        name: newName,
                        icon: emoji,
                        color: getCategoryColor(id)
                    }),
                });

                if (response.ok) {
                    log(`âœ… æ•°æ®åº“åŒæ­¥æˆåŠŸ: ${id}`, 'success');
                    showStatus(`âœ… åˆ†ç±»"${fullName}"ä¿å­˜æˆåŠŸ`, 'success');
                } else {
                    log(`âš ï¸ æ•°æ®åº“åŒæ­¥å¤±è´¥: ${response.status}`, 'warning');
                    showStatus(`âš ï¸ æ•°æ®åº“åŒæ­¥å¤±è´¥ï¼Œä½†localStorageå·²æ›´æ–°`, 'warning');
                }

                editingId = null;
                renderCategories();
                updateDataDisplay();

            } catch (error) {
                log(`âŒ ä¿å­˜è¿‡ç¨‹å‡ºé”™: ${error.message}`, 'error');
                showStatus(`âŒ ä¿å­˜å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // å–æ¶ˆç¼–è¾‘
        function cancelEdit() {
            editingId = null;
            log('âŒ å–æ¶ˆç¼–è¾‘', 'info');
            renderCategories();
        }

        // è·å–åˆ†ç±»é¢œè‰²
        function getCategoryColor(id) {
            const colorMap = {
                'uncategorized': '#6B7280',
                'tech-research': '#3B82F6',
                'market-analysis': '#10B981',
                'product-review': '#F59E0B',
                'industry-insights': '#8B5CF6'
            };
            return colorMap[id] || '#6B7280';
        }

        // åˆ·æ–°åˆ†ç±»åˆ—è¡¨
        function refreshCategories() {
            log('ğŸ”„ åˆ·æ–°åˆ†ç±»åˆ—è¡¨...', 'info');
            initializeCategories();
            renderCategories();
            updateDataDisplay();
        }

        // æ£€æŸ¥æŒä¹…åŒ–çŠ¶æ€
        async function checkPersistence() {
            log('ğŸ” æ£€æŸ¥æŒä¹…åŒ–çŠ¶æ€...', 'info');
            
            // æ£€æŸ¥localStorage
            const localData = localStorage.getItem('predefined_category_names');
            log(`ğŸ“± localStorage: ${localData ? 'æœ‰æ•°æ®' : 'æ— æ•°æ®'}`, localData ? 'success' : 'error');

            // æ£€æŸ¥æ•°æ®åº“
            try {
                const response = await fetch('/api/categories');
                if (response.ok) {
                    const data = await response.json();
                    const predefinedCategories = data.categories.filter(cat => cat.id.startsWith('predefined-'));
                    log(`ğŸ—„ï¸ æ•°æ®åº“: æ‰¾åˆ° ${predefinedCategories.length} ä¸ªé¢„å®šä¹‰åˆ†ç±»`, 'success');
                    
                    // æ˜¾ç¤ºæ•°æ®åº“ä¸­çš„åˆ†ç±»
                    predefinedCategories.forEach(cat => {
                        log(`   - ${cat.id}: ${cat.name}`, 'info');
                    });
                } else {
                    log(`âŒ æ•°æ®åº“æ£€æŸ¥å¤±è´¥: ${response.status}`, 'error');
                }
            } catch (error) {
                log(`âŒ æ•°æ®åº“è¿æ¥å¤±è´¥: ${error.message}`, 'error');
            }

            updateDataDisplay();
        }

        // æ›´æ–°æ•°æ®æ˜¾ç¤º
        async function updateDataDisplay() {
            // æ›´æ–°localStorageæ˜¾ç¤º
            const localData = localStorage.getItem('predefined_category_names');
            const localDiv = document.getElementById('localStorage-data');
            if (localData) {
                localDiv.textContent = JSON.stringify(JSON.parse(localData), null, 2);
            } else {
                localDiv.textContent = 'æ— æ•°æ®';
            }

            // æ›´æ–°æ•°æ®åº“æ˜¾ç¤º
            const dbDiv = document.getElementById('database-data');
            try {
                const response = await fetch('/api/categories');
                if (response.ok) {
                    const data = await response.json();
                    const predefinedCategories = data.categories.filter(cat => cat.id.startsWith('predefined-'));
                    const dbData = {};
                    predefinedCategories.forEach(cat => {
                        const frontendId = cat.id.replace('predefined-', '');
                        dbData[frontendId] = `${cat.icon || ''} ${cat.name}`.trim();
                    });
                    dbDiv.textContent = JSON.stringify(dbData, null, 2);
                } else {
                    dbDiv.textContent = `æ•°æ®åº“è¿æ¥å¤±è´¥: ${response.status}`;
                }
            } catch (error) {
                dbDiv.textContent = `æ•°æ®åº“è¿æ¥å¤±è´¥: ${error.message}`;
            }
        }

        // æ˜¾ç¤ºçŠ¶æ€æ¶ˆæ¯
        function showStatus(message, type) {
            const existing = document.querySelector('.status');
            if (existing) existing.remove();

            const div = document.createElement('div');
            div.className = `status ${type}`;
            div.textContent = message;
            document.querySelector('.container').insertBefore(div, document.querySelector('.test-section'));

            setTimeout(() => div.remove(), 3000);
        }

        // è¿è¡Œè‡ªåŠ¨æµ‹è¯•
        async function runAutoTest() {
            log('ğŸ¤– å¼€å§‹è‡ªåŠ¨æµ‹è¯•...', 'info');
            
            // æµ‹è¯•1: ä¿®æ”¹ä¸€ä¸ªåˆ†ç±»åç§°
            const testId = 'tech-research';
            const originalName = categories[testId];
            const testName = `ğŸ’» æµ‹è¯•åç§°${Date.now()}`;
            
            log(`æµ‹è¯•1: ä¿®æ”¹åˆ†ç±» ${testId}`, 'info');
            categories[testId] = testName;
            localStorage.setItem('predefined_category_names', JSON.stringify(categories));
            
            // åŒæ­¥åˆ°æ•°æ®åº“
            try {
                const response = await fetch('/api/categories/predefined', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        categoryId: testId,
                        name: testName.replace('ğŸ’» ', ''),
                        icon: 'ğŸ’»',
                        color: '#3B82F6'
                    }),
                });
                
                if (response.ok) {
                    log('âœ… è‡ªåŠ¨æµ‹è¯•ä¿å­˜æˆåŠŸ', 'success');
                } else {
                    log('âŒ è‡ªåŠ¨æµ‹è¯•ä¿å­˜å¤±è´¥', 'error');
                }
            } catch (error) {
                log(`âŒ è‡ªåŠ¨æµ‹è¯•å‡ºé”™: ${error.message}`, 'error');
            }

            renderCategories();
            updateDataDisplay();
            
            // 3ç§’åæ¢å¤åŸåç§°
            setTimeout(async () => {
                log('ğŸ”„ æ¢å¤åŸåˆ†ç±»åç§°...', 'info');
                categories[testId] = originalName;
                localStorage.setItem('predefined_category_names', JSON.stringify(categories));
                
                try {
                    await fetch('/api/categories/predefined', {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            categoryId: testId,
                            name: originalName.replace('ğŸ’» ', ''),
                            icon: 'ğŸ’»',
                            color: '#3B82F6'
                        }),
                    });
                    log('âœ… åˆ†ç±»åç§°å·²æ¢å¤', 'success');
                } catch (error) {
                    log(`âŒ æ¢å¤å¤±è´¥: ${error.message}`, 'error');
                }
                
                renderCategories();
                updateDataDisplay();
            }, 3000);
        }

        // æµ‹è¯•é¡µé¢åˆ·æ–°
        function testRefresh() {
            showStatus('ğŸ”„ å³å°†åˆ·æ–°é¡µé¢æµ‹è¯•æŒä¹…åŒ–...', 'info');
            setTimeout(() => {
                window.location.reload();
            }, 1000);
        }

        // æ¸…ç©ºæ—¥å¿—
        function clearLog() {
            document.getElementById('test-log').innerHTML = '';
        }

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        window.addEventListener('load', function() {
            log('ğŸš€ åˆ†ç±»æŒä¹…åŒ–æµ‹è¯•å·¥å…·åŠ è½½å®Œæˆ', 'success');
            initializeCategories();
            renderCategories();
            updateDataDisplay();
            checkPersistence();
        });
    </script>
</body>
</html> 