<!doctype html>
<html>
  <head>
    <title>åˆ†ç±»ç¼–è¾‘localStorageæµ‹è¯•</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        padding: 20px;
      }
      .test-section {
        margin: 20px 0;
        padding: 15px;
        border: 1px solid #ccc;
        border-radius: 5px;
      }
      button {
        padding: 10px 15px;
        margin: 5px;
        background: #007bff;
        color: white;
        border: none;
        border-radius: 3px;
        cursor: pointer;
      }
      button:hover {
        background: #0056b3;
      }
      .result {
        margin: 10px 0;
        padding: 10px;
        background: #f8f9fa;
        border-radius: 3px;
      }
      .error {
        background: #f8d7da;
        color: #721c24;
      }
      .success {
        background: #d4edda;
        color: #155724;
      }
      pre {
        background: #f1f1f1;
        padding: 10px;
        border-radius: 3px;
        overflow-x: auto;
      }
    </style>
  </head>
  <body>
    <h1>ğŸ” åˆ†ç±»ç¼–è¾‘localStorageè°ƒè¯•å·¥å…·</h1>

    <div class="test-section">
      <h3>1. localStorageåŸºç¡€æµ‹è¯•</h3>
      <button onclick="testBasicStorage()">æµ‹è¯•åŸºç¡€è¯»å†™</button>
      <div id="basic-result" class="result"></div>
    </div>

    <div class="test-section">
      <h3>2. æ¨¡æ‹Ÿåˆ†ç±»ç¼–è¾‘æµç¨‹</h3>
      <input
        type="text"
        id="category-name"
        placeholder="è¾“å…¥æ–°çš„åˆ†ç±»åç§°"
        value="ğŸ’» æµ‹è¯•æŠ€æœ¯ç ”ç©¶"
      />
      <button onclick="simulateCategoryEdit()">æ¨¡æ‹Ÿç¼–è¾‘ä¿å­˜</button>
      <div id="edit-result" class="result"></div>
    </div>

    <div class="test-section">
      <h3>3. æŸ¥çœ‹å½“å‰localStorageæ•°æ®</h3>
      <button onclick="showCurrentData()">æ˜¾ç¤ºæ‰€æœ‰æ•°æ®</button>
      <button onclick="clearAllData()">æ¸…é™¤æ‰€æœ‰æ•°æ®</button>
      <div id="data-result" class="result"></div>
    </div>

    <div class="test-section">
      <h3>4. åˆ·æ–°æŒä¹…åŒ–æµ‹è¯•</h3>
      <p>æ‰§è¡Œä»¥ä¸‹æ­¥éª¤ï¼š</p>
      <ol>
        <li>ç‚¹å‡»"æ¨¡æ‹Ÿç¼–è¾‘ä¿å­˜"</li>
        <li>æŸ¥çœ‹ä¿å­˜ç»“æœ</li>
        <li>åˆ·æ–°æ­¤é¡µé¢(F5)</li>
        <li>å†æ¬¡ç‚¹å‡»"æ˜¾ç¤ºæ‰€æœ‰æ•°æ®"</li>
        <li>éªŒè¯æ•°æ®æ˜¯å¦è¿˜åœ¨</li>
      </ol>
    </div>

    <script>
      function log(message, type = "info") {
        console.log(`[${new Date().toISOString()}] ${message}`);
      }

      function showResult(elementId, message, isError = false) {
        const element = document.getElementById(elementId);
        element.innerHTML = message;
        element.className = "result " + (isError ? "error" : "success");
      }

      function testBasicStorage() {
        try {
          const testKey = "test_storage";
          const testValue = {
            message: "hello",
            timestamp: new Date().toISOString(),
          };

          // å†™å…¥æµ‹è¯•
          localStorage.setItem(testKey, JSON.stringify(testValue));
          log("å†™å…¥localStorageæˆåŠŸ");

          // è¯»å–æµ‹è¯•
          const retrieved = localStorage.getItem(testKey);
          const parsed = JSON.parse(retrieved);

          // æ¸…ç†
          localStorage.removeItem(testKey);

          showResult(
            "basic-result",
            `
                    âœ… localStorageåŸºç¡€åŠŸèƒ½æ­£å¸¸<br>
                    å†™å…¥: ${JSON.stringify(testValue)}<br>
                    è¯»å–: ${JSON.stringify(parsed)}<br>
                    åŒ¹é…: ${JSON.stringify(testValue) === JSON.stringify(parsed) ? "æ˜¯" : "å¦"}
                `,
          );
        } catch (error) {
          showResult(
            "basic-result",
            `âŒ localStorageåŸºç¡€æµ‹è¯•å¤±è´¥: ${error.message}`,
            true,
          );
        }
      }

      function simulateCategoryEdit() {
        try {
          const categoryName = document.getElementById("category-name").value;
          const categoryId = "tech-research";

          log(`å¼€å§‹æ¨¡æ‹Ÿåˆ†ç±»ç¼–è¾‘: ${categoryId} -> ${categoryName}`);

          // æ­¥éª¤1: è¯»å–ç°æœ‰æ•°æ®
          const existing =
            localStorage.getItem("predefined_category_names") || "{}";
          const currentNames = JSON.parse(existing);
          log(`ç°æœ‰æ•°æ®: ${JSON.stringify(currentNames)}`);

          // æ­¥éª¤2: æ›´æ–°æ•°æ®
          const updatedNames = {
            ...currentNames,
            [categoryId]: categoryName,
          };
          log(`æ›´æ–°åæ•°æ®: ${JSON.stringify(updatedNames)}`);

          // æ­¥éª¤3: ä¿å­˜åˆ°localStorage
          localStorage.setItem(
            "predefined_category_names",
            JSON.stringify(updatedNames),
          );
          log("æ•°æ®å·²ä¿å­˜åˆ°localStorage");

          // æ­¥éª¤4: ç«‹å³éªŒè¯
          const verification = localStorage.getItem(
            "predefined_category_names",
          );
          const verifiedData = JSON.parse(verification);
          log(`éªŒè¯è¯»å–: ${JSON.stringify(verifiedData)}`);

          const success = verifiedData[categoryId] === categoryName;

          showResult(
            "edit-result",
            `
                    ğŸ“ æ¨¡æ‹Ÿç¼–è¾‘å®Œæˆ<br>
                    åˆ†ç±»ID: ${categoryId}<br>
                    æ–°åç§°: ${categoryName}<br>
                    ä¿å­˜çŠ¶æ€: ${success ? "âœ… æˆåŠŸ" : "âŒ å¤±è´¥"}<br>
                    éªŒè¯ç»“æœ: ${verifiedData[categoryId] || "æœªæ‰¾åˆ°"}<br>
                    æ—¶é—´æˆ³: ${new Date().toISOString()}
                `,
            !success,
          );
        } catch (error) {
          showResult("edit-result", `âŒ æ¨¡æ‹Ÿç¼–è¾‘å¤±è´¥: ${error.message}`, true);
        }
      }

      function showCurrentData() {
        try {
          const allKeys = Object.keys(localStorage);
          const relevantKeys = allKeys.filter(
            (key) => key.includes("category") || key.includes("predefined"),
          );

          let output = "<h4>ç›¸å…³localStorageæ•°æ®:</h4>";

          if (relevantKeys.length === 0) {
            output += "<p>âŒ æ²¡æœ‰æ‰¾åˆ°ç›¸å…³çš„localStorageæ•°æ®</p>";
          } else {
            relevantKeys.forEach((key) => {
              const value = localStorage.getItem(key);
              try {
                const parsed = JSON.parse(value);
                output += `
                                <div style="margin: 10px 0;">
                                    <strong>${key}:</strong><br>
                                    <pre>${JSON.stringify(parsed, null, 2)}</pre>
                                </div>
                            `;
              } catch {
                output += `
                                <div style="margin: 10px 0;">
                                    <strong>${key}:</strong><br>
                                    <pre>${value}</pre>
                                </div>
                            `;
              }
            });
          }

          output += `<p><small>æ€»å…± ${allKeys.length} ä¸ªlocalStorageé”®ï¼Œå…¶ä¸­ ${relevantKeys.length} ä¸ªç›¸å…³</small></p>`;

          showResult("data-result", output);
        } catch (error) {
          showResult("data-result", `âŒ è¯»å–æ•°æ®å¤±è´¥: ${error.message}`, true);
        }
      }

      function clearAllData() {
        if (confirm("ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰ç›¸å…³çš„localStorageæ•°æ®å—ï¼Ÿ")) {
          const keys = [
            "predefined_category_names",
            "custom_categories",
            "category_order",
            "hidden_categories",
          ];
          keys.forEach((key) => localStorage.removeItem(key));
          showResult("data-result", "ğŸ§¹ æ‰€æœ‰ç›¸å…³æ•°æ®å·²æ¸…é™¤");
          log("localStorageæ•°æ®å·²æ¸…é™¤");
        }
      }

      // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ˜¾ç¤ºå½“å‰æ•°æ®
      window.onload = function () {
        showCurrentData();
        log("è°ƒè¯•é¡µé¢åŠ è½½å®Œæˆ");
      };
    </script>
  </body>
</html>
